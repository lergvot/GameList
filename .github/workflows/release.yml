name: Release

on:
  push:
    tags:
      - "v*"
permissions:
  contents: write

jobs:
  build:
    runs-on: windows-latest
    defaults:
      run:
        shell: bash

    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0 # –î–ª—è changelog

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install pyinstaller

      - name: Verify version
        run: |
          # –ò–∑–≤–ª–µ–∫–∞–µ–º –≤–µ—Ä—Å–∏—é –∏–∑ main.py
          PY_VERSION=$(grep 'APP_VERSION' main.py | grep -oE '[0-9]+\.[0-9]+\.[0-9]+')
          TAG_VERSION="${GITHUB_REF#refs/tags/v}"

          echo "–í–µ—Ä—Å–∏—è –≤ main.py: $PY_VERSION"
          echo "–í–µ—Ä—Å–∏—è —Ç–µ–≥–∞: $TAG_VERSION"

          if [ "$PY_VERSION" != "$TAG_VERSION" ]; then
            echo "‚ùå –í–µ—Ä—Å–∏–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç!"
            exit 1
          fi

          echo "‚úÖ –í–µ—Ä—Å–∏–∏ —Å–æ–≤–ø–∞–¥–∞—é—Ç"

      - name: Build release
        run: python build.py --release

      - name: Generate changelog
        run: |
          # –ü–æ–ª—É—á–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π —Ç–µ–≥
          git fetch --tags --force
          previous_tag=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")

          # –ü–æ–ª—É—á–∞–µ–º URL —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è –¥–ª—è —Å—Å—ã–ª–æ–∫
          REPO_URL="$GITHUB_SERVER_URL/$GITHUB_REPOSITORY"

          if [ -z "$previous_tag" ]; then
            echo "### üéÆ Games List Manager ${{ github.ref_name }}" > changelog.md
            echo "–ü–µ—Ä–≤—ã–π —Ä–µ–ª–∏–∑!" >> changelog.md
            echo "" >> changelog.md
            echo "#### –í—Å–µ –∫–æ–º–º–∏—Ç—ã:" >> changelog.md
            # –í—ã–≤–æ–¥–∏–º –∫–æ–º–º–∏—Ç—ã —Å —Ö—ç—à–∞–º–∏ –∏ —Å—Å—ã–ª–∫–∞–º–∏
            git log --pretty=format:"- [%h]($REPO_URL/commit/%H) %s" --no-merges >> changelog.md
          else
            echo "### üéÆ Games List Manager ${{ github.ref_name }}" > changelog.md
            echo "" >> changelog.md
            echo "#### –ò–∑–º–µ–Ω–µ–Ω–∏—è —Å $previous_tag:" >> changelog.md
            # –í—ã–≤–æ–¥–∏–º –∫–æ–º–º–∏—Ç—ã —Å —Ö—ç—à–∞–º–∏ –∏ —Å—Å—ã–ª–∫–∞–º–∏
            git log --pretty=format:"- [%h]($REPO_URL/commit/%H) %s" --no-merges $previous_tag..HEAD >> changelog.md
          fi

          echo "" >> changelog.md
          echo "---" >> changelog.md
          echo "*–†–µ–ª–∏–∑ —Å–æ–∑–¥–∞–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏*" >> changelog.md

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          name: Games List Manager ${{ github.ref_name }}
          body_path: changelog.md
          files: dist/*.zip # –¢–û–õ–¨–ö–û –Ω–∞—à ZIP —Å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ–º
          draft: false
          prerelease: false
