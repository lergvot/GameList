name: Release

on:
  push:
    tags:
      - "v*"
permissions:
  contents: write

jobs:
  build:
    runs-on: windows-latest
    defaults:
      run:
        shell: bash

    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0 # For changelog

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install pyinstaller

      - name: Verify version
        run: |
          # Extract version from config.py
          PY_VERSION=$(python3 -c "import config; print(config.APP_VERSION)")
          TAG_VERSION="${GITHUB_REF#refs/tags/v}"

          echo "Version in config.py: $PY_VERSION"
          echo "Tag version: $TAG_VERSION"

          if [ "$PY_VERSION" != "$TAG_VERSION" ]; then
            echo "âŒ Version mismatch!"
            exit 1
          fi

          echo "âœ… Versions match"

      - name: Build release
        run: python build.py --release

      - name: Generate changelog
        run: |
          # Get previous tag
          git fetch --tags --force
          previous_tag=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")

          # Get repository URL for links
          REPO_URL="$GITHUB_SERVER_URL/$GITHUB_REPOSITORY"

          if [ -z "$previous_tag" ]; then
            echo "### ðŸŽ® Games List Manager ${{ github.ref_name }}" > changelog.md
            echo "First release!" >> changelog.md
            echo "" >> changelog.md
            echo "#### All commits:" >> changelog.md
            # Show commits with hashes and links
            git log --pretty=format:"- [%h]($REPO_URL/commit/%H) %s" --no-merges >> changelog.md
          else
            echo "### ðŸŽ® Games List Manager ${{ github.ref_name }}" > changelog.md
            echo "" >> changelog.md
            echo "#### Changes since $previous_tag:" >> changelog.md
            # Show commits with hashes and links
            git log --pretty=format:"- [%h]($REPO_URL/commit/%H) %s" --no-merges $previous_tag..HEAD >> changelog.md
          fi

          echo "" >> changelog.md
          echo "---" >> changelog.md
          echo "*Automatically generated release*" >> changelog.md

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          name: Games List Manager ${{ github.ref_name }}
          body_path: changelog.md
          files: dist/*.zip
          draft: false
          prerelease: false
