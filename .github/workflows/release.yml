name: Release

on:
  push:
    tags:
      - "v*"

jobs:
  build:
    runs-on: windows-latest

    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0 # –î–ª—è changelog

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.12"

      - name: Install PyInstaller
        run: pip install pyinstaller

      - name: Verify version
        run: |
          python -c "
          import re
          with open('main.py', 'r', encoding='utf-8') as f:
              content = f.read()
          match = re.search(r'APP_VERSION\\s*=\\s*[\"\\']([^\"\\']+)[\"\\']', content)
          if match:
              py_version = match.group(1)
              tag_version = '${{ github.ref_name }}'.lstrip('v')
              if py_version != tag_version:
                  print(f'‚ùå –í–µ—Ä—Å–∏—è –≤ main.py ({py_version}) –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å —Ç–µ–≥–æ–º ({tag_version})')
                  exit(1)
              print(f'‚úÖ –í–µ—Ä—Å–∏–∏ —Å–æ–≤–ø–∞–¥–∞—é—Ç: {py_version}')
          else:
              print('‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è APP_VERSION –≤ main.py')
              exit(1)
          "

      - name: Build release
        run: python build.py --release

      - name: Generate changelog
        run: |
          # –ü–æ–ª—É—á–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π —Ç–µ–≥
          git fetch --tags --force
          previous_tag=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")

          if [ -z "$previous_tag" ]; then
            echo "### üéÆ Games List Manager ${{ github.ref_name }}" > changelog.md
            echo "–ü–µ—Ä–≤—ã–π —Ä–µ–ª–∏–∑!" >> changelog.md
            echo "" >> changelog.md
            echo "#### –í—Å–µ –∫–æ–º–º–∏—Ç—ã:" >> changelog.md
            git log --pretty=format:"- %s" --no-merges >> changelog.md
          else
            echo "### üéÆ Games List Manager ${{ github.ref_name }}" > changelog.md
            echo "" >> changelog.md
            echo "#### –ò–∑–º–µ–Ω–µ–Ω–∏—è —Å $previous_tag:" >> changelog.md
            git log --pretty=format:"- %s" --no-merges $previous_tag..HEAD >> changelog.md
          fi

          echo "" >> changelog.md
          echo "---" >> changelog.md
          echo "*–†–µ–ª–∏–∑ —Å–æ–∑–¥–∞–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏*" >> changelog.md

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          name: Games List Manager ${{ github.ref_name }}
          body_path: changelog.md
          files: dist/*.zip # –¢–û–õ–¨–ö–û –Ω–∞—à ZIP —Å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ–º
          draft: false
          prerelease: false
